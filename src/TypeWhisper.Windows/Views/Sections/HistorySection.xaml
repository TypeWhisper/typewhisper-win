<UserControl x:Class="TypeWhisper.Windows.Views.Sections.HistorySection"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:TypeWhisper.Windows.Converters">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Styles/UnifiedSettingsStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
            <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVis"/>
        </ResourceDictionary>
    </UserControl.Resources>

    <DockPanel Margin="24">
        <!-- Header -->
        <TextBlock DockPanel.Dock="Top" Text="Verlauf" Style="{StaticResource SectionHeaderStyle}"/>

        <!-- Toolbar -->
        <Grid DockPanel.Dock="Top" Margin="0,0,0,8">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Labels row -->
            <TextBlock Grid.Row="0" Grid.Column="0" Text="Suche" Style="{StaticResource LabelStyle}"/>
            <TextBlock Grid.Row="0" Grid.Column="1" Text="App" Style="{StaticResource LabelStyle}" Margin="0,0,8,0"/>

            <!-- Controls row -->
            <TextBox Grid.Row="1" Grid.Column="0"
                     Text="{Binding History.SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                     Style="{StaticResource InputTextBoxStyle}" Margin="0,0,8,0"/>

            <ComboBox Grid.Row="1" Grid.Column="1"
                      ItemsSource="{Binding History.AvailableApps}"
                      SelectedItem="{Binding History.SelectedAppFilter}"
                      Style="{StaticResource InputComboBoxStyle}"
                      ItemContainerStyle="{StaticResource InputComboBoxItemStyle}"
                      Width="150" Margin="0,0,8,0" IsEditable="False"/>

            <Button Grid.Row="1" Grid.Column="2" Content="Exportieren"
                    Command="{Binding History.ExportCommand}"
                    Style="{StaticResource SecondaryButtonStyle}" Padding="12,7" Margin="0,0,8,0"/>
            <Button Grid.Row="1" Grid.Column="3" Content="Alle löschen"
                    Command="{Binding History.ClearAllCommand}"
                    Style="{StaticResource DangerButtonStyle}" Padding="12,7"/>
        </Grid>

        <!-- Stats -->
        <TextBlock DockPanel.Dock="Top" HorizontalAlignment="Right"
                   Foreground="{StaticResource HintBrush}" Margin="0,0,0,12">
            <Run Text="{Binding History.TotalRecords, Mode=OneWay}"/> Einträge,
            <Run Text="{Binding History.TotalWords, Mode=OneWay}"/> Wörter
        </TextBlock>

        <!-- Empty state -->
        <TextBlock DockPanel.Dock="Top" Text="Noch keine Aufnahmen"
                   Foreground="{StaticResource HintBrush}" FontSize="14"
                   HorizontalAlignment="Center" Margin="0,40,0,0">
            <TextBlock.Style>
                <Style TargetType="TextBlock">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding History.TotalRecords}" Value="0">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </TextBlock.Style>
        </TextBlock>

        <!-- Timeline -->
        <ScrollViewer VerticalScrollBarVisibility="Auto" Style="{x:Null}">
            <ScrollViewer.Resources>
                <Style TargetType="ScrollBar" BasedOn="{StaticResource SettingsScrollBarStyle}"/>
            </ScrollViewer.Resources>

            <ItemsControl ItemsSource="{Binding History.GroupedEntries}"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.IsVirtualizingWhenGrouping="True"
                          VirtualizingPanel.VirtualizationMode="Recycling">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <VirtualizingStackPanel/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <!-- Group header: "Heute" / "Gestern" / etc. with line -->
                <ItemsControl.GroupStyle>
                    <GroupStyle>
                        <GroupStyle.HeaderTemplate>
                            <DataTemplate>
                                <Grid Margin="42,16,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{Binding Name}"
                                               Style="{StaticResource TimelineGroupHeaderStyle}"
                                               Margin="0,0,12,0"/>
                                    <Rectangle Grid.Column="1" Height="1"
                                               Fill="{StaticResource BorderBrush}"
                                               VerticalAlignment="Center"/>
                                </Grid>
                            </DataTemplate>
                        </GroupStyle.HeaderTemplate>
                    </GroupStyle>
                </ItemsControl.GroupStyle>

                <!-- Timeline entry -->
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin="0,0,0,2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="42"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Left: vertical line + dot -->
                            <Grid Grid.Column="0">
                                <Rectangle Width="2" Fill="{StaticResource BorderBrush}"
                                           HorizontalAlignment="Center"/>
                                <Ellipse Style="{StaticResource TimelineDotStyle}"
                                         VerticalAlignment="Top" HorizontalAlignment="Center"
                                         Margin="0,14,0,0"/>
                            </Grid>

                            <!-- Right: card -->
                            <Border Grid.Column="1" Style="{StaticResource TimelineCardStyle}"
                                    Margin="0,4,8,4">
                                <Border.InputBindings>
                                    <MouseBinding MouseAction="LeftClick"
                                                  Command="{Binding ToggleExpandCommand}"/>
                                </Border.InputBindings>

                                <StackPanel>
                                    <!-- Collapsed: time + preview + badges -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0" Text="{Binding TimeLabel}"
                                                   Foreground="{StaticResource HintBrush}" FontSize="12"
                                                   VerticalAlignment="Top" Margin="0,0,10,0"/>

                                        <TextBlock Grid.Column="1" Text="{Binding Record.Preview}"
                                                   Foreground="{StaticResource TextBrush}" FontSize="13"
                                                   TextTrimming="CharacterEllipsis"
                                                   VerticalAlignment="Top"/>

                                        <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="8,0,0,0">
                                            <Border Style="{StaticResource BadgeStyle}"
                                                    Background="#2A3A5A"
                                                    Visibility="{Binding Record.ProfileName, Converter={StaticResource BoolToVis}, FallbackValue=Collapsed}">
                                                <TextBlock Text="{Binding Record.ProfileName}"
                                                           Foreground="{StaticResource AccentBrush}" FontSize="11"/>
                                            </Border>
                                            <Border Style="{StaticResource BadgeStyle}"
                                                    Visibility="{Binding Record.AppProcessName, Converter={StaticResource BoolToVis}, FallbackValue=Collapsed}">
                                                <TextBlock Text="{Binding Record.AppProcessName}"
                                                           Foreground="{StaticResource HintBrush}" FontSize="11"/>
                                            </Border>
                                            <Border Style="{StaticResource BadgeStyle}">
                                                <TextBlock Text="{Binding DurationLabel}"
                                                           Foreground="{StaticResource HintBrush}" FontSize="11"/>
                                            </Border>
                                        </StackPanel>
                                    </Grid>

                                    <!-- Expanded -->
                                    <StackPanel Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVis}}">
                                        <Rectangle Height="1" Fill="{StaticResource BorderBrush}" Margin="0,8,0,8"/>

                                        <!-- Full text (read-only) -->
                                        <TextBlock Text="{Binding Record.FinalText}" TextWrapping="Wrap"
                                                   Foreground="{StaticResource TextBrush}" FontSize="13"
                                                   Margin="0,0,0,8"
                                                   Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVis}}"/>

                                        <!-- Edit mode -->
                                        <StackPanel Visibility="{Binding IsEditing, Converter={StaticResource BoolToVis}}">
                                            <TextBox Text="{Binding EditText, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{StaticResource InputTextBoxStyle}"
                                                     TextWrapping="Wrap" AcceptsReturn="True"
                                                     MinHeight="60" MaxHeight="200" Margin="0,0,0,8"/>
                                            <StackPanel Orientation="Horizontal">
                                                <Button Content="Speichern" Command="{Binding SaveEditCommand}"
                                                        Style="{StaticResource PrimaryButtonStyle}"
                                                        Padding="12,6" Margin="0,0,6,0"/>
                                                <Button Content="Abbrechen" Command="{Binding CancelEditCommand}"
                                                        Style="{StaticResource SecondaryButtonStyle}"
                                                        Padding="12,6"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Meta -->
                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,4"
                                                    Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVis}}">
                                            <TextBlock Foreground="{StaticResource HintBrush}" FontSize="11">
                                                <Run Text="{Binding Record.Timestamp, StringFormat='{}{0:dd.MM.yyyy HH:mm}', Mode=OneWay}"/>
                                                <Run Text=" · "/>
                                                <Run Text="{Binding Record.WordCount, StringFormat='{}{0} Wörter', Mode=OneWay}"/>
                                            </TextBlock>
                                            <TextBlock Foreground="{StaticResource HintBrush}" FontSize="11"
                                                       Margin="8,0,0,0"
                                                       Visibility="{Binding Record.Language, Converter={StaticResource BoolToVis}, FallbackValue=Collapsed}">
                                                <Run Text="· "/>
                                                <Run Text="{Binding Record.Language, Mode=OneWay}"/>
                                            </TextBlock>
                                        </StackPanel>

                                        <!-- Action buttons -->
                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0"
                                                    Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVis}}">
                                            <Button Content="Bearbeiten" Command="{Binding StartEditCommand}"
                                                    Style="{StaticResource LinkButtonStyle}" Margin="0,0,12,0"/>
                                            <Button Content="Kopieren" Command="{Binding CopyCommand}"
                                                    Style="{StaticResource LinkButtonStyle}" Margin="0,0,12,0"/>
                                            <Button Content="Löschen" Command="{Binding DeleteCommand}"
                                                    Style="{StaticResource LinkButtonStyle}"
                                                    Foreground="{StaticResource DangerBrush}"/>
                                        </StackPanel>
                                    </StackPanel>

                                </StackPanel>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </DockPanel>
</UserControl>
