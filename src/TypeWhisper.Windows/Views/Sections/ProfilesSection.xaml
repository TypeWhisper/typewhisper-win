<UserControl x:Class="TypeWhisper.Windows.Views.Sections.ProfilesSection"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:TypeWhisper.Windows.ViewModels"
             xmlns:conv="clr-namespace:TypeWhisper.Windows.Converters">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Styles/UnifiedSettingsStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <BooleanToVisibilityConverter x:Key="BoolToVis"/>
            <conv:ProfileSubtitleConverter x:Key="ProfileSubtitleConverter"/>
            <conv:NonEmptyToVisibilityConverter x:Key="NonEmptyToVisibility"/>

            <!-- Chip remove button style -->
            <Style x:Key="ChipRemoveButtonStyle" TargetType="Button">
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="ChipCloseBorder"
                                    Background="Transparent"
                                    CornerRadius="8"
                                    Padding="4,1"
                                    Margin="4,0,0,0"
                                    Cursor="Hand">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="ChipCloseBorder" Property="Background" Value="#55FFFFFF"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- Toggle Switch style -->
            <Style x:Key="ToggleSwitchStyle" TargetType="CheckBox">
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="CheckBox">
                            <Grid Cursor="Hand">
                                <Border x:Name="Track"
                                        Width="36" Height="20"
                                        CornerRadius="10"
                                        Background="#444444">
                                    <Ellipse x:Name="Thumb"
                                             Width="16" Height="16"
                                             Fill="#AAAAAA"
                                             HorizontalAlignment="Left"
                                             Margin="2,0,0,0"/>
                                </Border>
                            </Grid>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsChecked" Value="True">
                                    <Setter TargetName="Track" Property="Background" Value="{StaticResource AccentBrush}"/>
                                    <Setter TargetName="Thumb" Property="Fill" Value="White"/>
                                    <Setter TargetName="Thumb" Property="HorizontalAlignment" Value="Right"/>
                                    <Setter TargetName="Thumb" Property="Margin" Value="0,0,2,0"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="240"/>
            <ColumnDefinition Width="1"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Left: Profile List -->
        <Grid Grid.Column="0" Background="{StaticResource SidebarBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <TextBlock Grid.Row="0" Text="Profile"
                       Style="{StaticResource SectionHeaderStyle}"
                       FontSize="16" Margin="16,16,16,8"/>

            <!-- Profile List -->
            <ListBox Grid.Row="1"
                     ItemsSource="{Binding Profiles.Profiles}"
                     SelectedItem="{Binding Profiles.SelectedProfile}"
                     Style="{StaticResource MasterListBoxStyle}"
                     Background="Transparent" BorderThickness="0"
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin="0,2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Profile Info -->
                            <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                <TextBlock Text="{Binding Name}" FontSize="13" FontWeight="SemiBold"
                                           Foreground="{StaticResource TextBrush}"
                                           TextTrimming="CharacterEllipsis"/>
                                <TextBlock Text="{Binding Converter={StaticResource ProfileSubtitleConverter}}"
                                           FontSize="11" Foreground="{StaticResource HintBrush}"
                                           TextTrimming="CharacterEllipsis" MaxWidth="160"/>
                            </StackPanel>

                            <!-- Toggle Switch -->
                            <CheckBox Grid.Column="1"
                                      Style="{StaticResource ToggleSwitchStyle}"
                                      IsChecked="{Binding IsEnabled, Mode=OneWay}"
                                      VerticalAlignment="Center"
                                      Command="{Binding DataContext.Profiles.ToggleProfileEnabledCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                      CommandParameter="{Binding}"/>
                        </Grid>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <!-- Add Profile Button -->
            <Button Grid.Row="2" Content="+ Neues Profil"
                    Style="{StaticResource SecondaryButtonStyle}"
                    Command="{Binding Profiles.AddProfileCommand}"
                    Margin="12" HorizontalAlignment="Stretch"/>
        </Grid>

        <!-- Divider -->
        <Border Grid.Column="1" Background="{StaticResource BorderBrush}"/>

        <!-- Right: Detail -->
        <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled"
                      Background="{StaticResource BackgroundBrush}">
            <StackPanel MaxWidth="500" Margin="24">
                <TextBlock Text="Profil bearbeiten" Style="{StaticResource SectionHeaderStyle}"/>

                <!-- Name -->
                <StackPanel Margin="0,0,0,20">
                    <TextBlock Text="Name" Style="{StaticResource LabelStyle}"/>
                    <TextBox Text="{Binding Profiles.EditName, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource InputTextBoxStyle}"/>
                </StackPanel>

                <!-- Process Names (Chips) -->
                <StackPanel Margin="0,0,0,20">
                    <TextBlock Text="Apps" Style="{StaticResource LabelStyle}"/>

                    <!-- Chips Container -->
                    <Border Background="{StaticResource InputBackgroundBrush}"
                            BorderBrush="{StaticResource BorderBrush}"
                            BorderThickness="1" CornerRadius="8" Padding="4">
                        <StackPanel>
                            <!-- Existing Chips -->
                            <ItemsControl ItemsSource="{Binding Profiles.ProcessNameChips}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#3D3D3D" CornerRadius="12"
                                                Padding="10,4,6,4" Margin="2">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding}"
                                                           Foreground="{StaticResource TextBrush}"
                                                           FontSize="12" VerticalAlignment="Center"/>
                                                <Button Content="&#x2715;"
                                                        Style="{StaticResource ChipRemoveButtonStyle}"
                                                        Foreground="{StaticResource HintBrush}" FontSize="10"
                                                        Command="{Binding DataContext.Profiles.RemoveProcessNameChipCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Input -->
                            <TextBox x:Name="ProcessNameInputBox"
                                     Text="{Binding Profiles.ProcessNameInput, UpdateSourceTrigger=PropertyChanged}"
                                     Background="Transparent" BorderThickness="0"
                                     Foreground="{StaticResource TextBrush}"
                                     CaretBrush="{StaticResource TextBrush}"
                                     FontSize="13" Padding="6,4"
                                     KeyDown="ProcessNameInputBox_KeyDown"/>
                        </StackPanel>
                    </Border>
                    <TextBlock Text="Prozessnamen eingeben und Enter drücken, oder laufende App anklicken"
                               Style="{StaticResource HintStyle}"/>

                    <!-- Running Apps Suggestions -->
                    <ItemsControl ItemsSource="{Binding Profiles.RunningApps}" Margin="0,6,0,0">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Margin="2" Padding="8,3" Cursor="Hand"
                                        Command="{Binding DataContext.Profiles.AddRunningAppCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="SugBorder"
                                                    Background="#2A2A2A" CornerRadius="12"
                                                    BorderBrush="#444444" BorderThickness="1"
                                                    Padding="{TemplateBinding Padding}">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="+" Foreground="{StaticResource AccentBrush}"
                                                               FontSize="12" Margin="0,0,4,0" VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding}" Foreground="{StaticResource HintBrush}"
                                                               FontSize="12" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="SugBorder" Property="Background" Value="#3D3D3D"/>
                                                    <Setter TargetName="SugBorder" Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <!-- URL Patterns (Chips) -->
                <StackPanel Margin="0,0,0,20">
                    <TextBlock Text="URL-Muster" Style="{StaticResource LabelStyle}"/>

                    <Border Background="{StaticResource InputBackgroundBrush}"
                            BorderBrush="{StaticResource BorderBrush}"
                            BorderThickness="1" CornerRadius="8" Padding="4">
                        <StackPanel>
                            <ItemsControl ItemsSource="{Binding Profiles.UrlPatternChips}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#3D3D3D" CornerRadius="12"
                                                Padding="10,4,6,4" Margin="2">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding}"
                                                           Foreground="{StaticResource TextBrush}"
                                                           FontSize="12" VerticalAlignment="Center"/>
                                                <Button Content="&#x2715;"
                                                        Style="{StaticResource ChipRemoveButtonStyle}"
                                                        Foreground="{StaticResource HintBrush}" FontSize="10"
                                                        Command="{Binding DataContext.Profiles.RemoveUrlPatternChipCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <TextBox x:Name="UrlPatternInputBox"
                                     Text="{Binding Profiles.UrlPatternInput, UpdateSourceTrigger=PropertyChanged}"
                                     Background="Transparent" BorderThickness="0"
                                     Foreground="{StaticResource TextBrush}"
                                     CaretBrush="{StaticResource TextBrush}"
                                     FontSize="13" Padding="6,4"
                                     KeyDown="UrlPatternInputBox_KeyDown"/>
                        </StackPanel>
                    </Border>
                    <TextBlock Text="URL-Muster eingeben und Enter drücken (z.B. slack.com, *.github.com)"
                               Style="{StaticResource HintStyle}"/>
                </StackPanel>

                <!-- Overrides Header -->
                <TextBlock Text="Überschreibungen" Style="{StaticResource SectionHeaderStyle}" FontSize="16" Margin="0,4,0,12"/>

                <!-- Language -->
                <StackPanel Margin="0,0,0,20">
                    <TextBlock Text="Sprache" Style="{StaticResource LabelStyle}"/>
                    <ComboBox SelectedValue="{Binding Profiles.EditLanguage}"
                              SelectedValuePath="Tag"
                              Style="{StaticResource InputComboBoxStyle}"
                              ItemContainerStyle="{StaticResource InputComboBoxItemStyle}"
                              HorizontalAlignment="Stretch">
                        <ComboBoxItem Content="Globale Einstellung" Tag="{x:Null}"/>
                        <ComboBoxItem Content="Auto" Tag="auto"/>
                        <ComboBoxItem Content="Deutsch" Tag="de"/>
                        <ComboBoxItem Content="English" Tag="en"/>
                        <ComboBoxItem Content="Français" Tag="fr"/>
                        <ComboBoxItem Content="Español" Tag="es"/>
                        <ComboBoxItem Content="Italiano" Tag="it"/>
                        <ComboBoxItem Content="Português" Tag="pt"/>
                        <ComboBoxItem Content="Nederlands" Tag="nl"/>
                        <ComboBoxItem Content="Polski" Tag="pl"/>
                    </ComboBox>
                </StackPanel>

                <!-- Translation Target -->
                <StackPanel Margin="0,0,0,20">
                    <TextBlock Text="Übersetzung" Style="{StaticResource LabelStyle}"/>
                    <ComboBox ItemsSource="{Binding Profiles.TranslationTargetOptions}"
                              SelectedValue="{Binding Profiles.EditTranslationTarget}"
                              SelectedValuePath="Code"
                              IsTextSearchEnabled="True" TextSearch.TextPath="DisplayName"
                              Style="{StaticResource InputComboBoxStyle}"
                              ItemContainerStyle="{StaticResource InputComboBoxItemStyle}"
                              HorizontalAlignment="Stretch">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Border Background="#2D5A8E" CornerRadius="3" Padding="5,1" MinWidth="28"
                                            Margin="0,0,8,0" VerticalAlignment="Center"
                                            Visibility="{Binding BadgeText, Converter={StaticResource NonEmptyToVisibility}}">
                                        <TextBlock Text="{Binding BadgeText}" FontSize="10" FontWeight="Bold"
                                                   Foreground="White" HorizontalAlignment="Center"
                                                   FontFamily="Consolas"/>
                                    </Border>
                                    <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center"/>
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                    <TextBlock Text="Überschreibt die globale Übersetzungseinstellung für dieses Profil"
                               Style="{StaticResource HintStyle}"/>
                </StackPanel>

                <!-- Whisper Mode Override -->
                <StackPanel Margin="0,0,0,16">
                    <CheckBox Style="{StaticResource InputCheckBoxStyle}"
                              IsChecked="{Binding Profiles.EditWhisperModeOverride}"
                              Content="Whisper-Modus überschreiben"/>
                    <TextBlock Text="Überschreibt die globale Whisper-Modus Einstellung"
                               Style="{StaticResource HintStyle}" Margin="26,4,0,0"/>
                </StackPanel>

                <!-- Transcription Model Override -->
                <StackPanel Margin="0,0,0,20">
                    <TextBlock Text="Transkriptions-Modell" Style="{StaticResource LabelStyle}"/>
                    <ComboBox ItemsSource="{Binding Profiles.AvailableModelOptions}"
                              SelectedValue="{Binding Profiles.EditTranscriptionModelOverride}"
                              SelectedValuePath="Id"
                              DisplayMemberPath="DisplayName"
                              Style="{StaticResource InputComboBoxStyle}"
                              ItemContainerStyle="{StaticResource InputComboBoxItemStyle}"
                              HorizontalAlignment="Stretch"/>
                    <TextBlock Text="Überschreibt das globale Modell für dieses Profil (lokal oder Cloud)"
                               Style="{StaticResource HintStyle}"/>
                </StackPanel>

                <!-- Priority -->
                <StackPanel Margin="0,0,0,20">
                    <TextBlock Text="Priorität" Style="{StaticResource LabelStyle}"/>
                    <TextBox Text="{Binding Profiles.EditPriority, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource InputTextBoxStyle}"
                             Width="100" HorizontalAlignment="Left"/>
                    <TextBlock Text="Höhere Zahl = höhere Priorität bei Mehrfach-Match"
                               Style="{StaticResource HintStyle}"/>
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                    <Button Content="Speichern"
                            Style="{StaticResource PrimaryButtonStyle}"
                            Command="{Binding Profiles.SaveProfileCommand}"
                            Margin="0,0,12,0"/>
                    <Button Content="Löschen"
                            Style="{StaticResource DangerButtonStyle}"
                            Command="{Binding Profiles.DeleteProfileCommand}"/>
                </StackPanel>

                <!-- Live Window Detection -->
                <Border Margin="0,30,0,0" Padding="12"
                        Background="{StaticResource SidebarBrush}" CornerRadius="8">
                    <StackPanel>
                        <TextBlock Text="Aktives Fenster"
                                   FontSize="12" FontWeight="SemiBold"
                                   Foreground="{StaticResource HintBrush}" Margin="0,0,0,8"/>
                        <TextBlock FontSize="12" Foreground="{StaticResource LabelBrush}">
                            <Run Text="Prozess: "/><Run Text="{Binding Profiles.CurrentProcessName, Mode=OneWay}" Foreground="#88CCFF"/>
                        </TextBlock>
                        <TextBlock FontSize="12" Foreground="{StaticResource LabelBrush}"
                                   TextTrimming="CharacterEllipsis">
                            <Run Text="Titel: "/><Run Text="{Binding Profiles.CurrentWindowTitle, Mode=OneWay}" Foreground="{StaticResource HintBrush}"/>
                        </TextBlock>
                        <TextBlock FontSize="12" Foreground="{StaticResource LabelBrush}"
                                   TextTrimming="CharacterEllipsis">
                            <Run Text="URL: "/><Run Text="{Binding Profiles.CurrentUrl, Mode=OneWay}" Foreground="#88FFCC"/>
                        </TextBlock>
                        <Border Margin="0,8,0,0" Padding="8,6" CornerRadius="4">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Background" Value="#1AD32F2F"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Profiles.HasMatchedProfile}" Value="True">
                                            <Setter Property="Background" Value="#1A4CAF50"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <TextBlock FontSize="12">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Foreground" Value="{StaticResource DangerBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Profiles.HasMatchedProfile}" Value="True">
                                                <Setter Property="Foreground" Value="{StaticResource ActiveIndicatorBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                                <Run Text="Profil: "/><Run Text="{Binding Profiles.MatchedProfileName, Mode=OneWay}"/>
                            </TextBlock>
                        </Border>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
